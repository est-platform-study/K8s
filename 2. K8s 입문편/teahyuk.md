
  
# K8s 개요

쿠버네티스는 컨테이너 오케스트레이션을 위한 서비스, 컨테이너 오케스트레이터 이다

#### 오케스트레이션

컴퓨팅 리로스 그룹을 가져와서 컨테이너 전용 API로 제공하여 컨테이너의 실행, 오류 복구, 스케줄, 로드밸런싱, dynamic scale-out등등을 제공하는 기능.

---

- 2장 살펴보기
  * [기본 오브젝트](#-------)
    + [Pod(파드)](#pod----)
    + [ReplicaSet(레플리카셋)](#replicaset-------)
    + [Service(서비스)](#service-----)
    + [스토리지](#----)
      - [Persistent Volume(영속성 볼륨)](#persistent-volume--------)
      - [Config Map](#config-map)
      - [Secret](#secret)
  * [구성 오브젝트](#-------)
    + [네임스페이스](#------)
    + [레이블](#---)
    + [어노테이션](#-----)
  * [고급 오브젝트](#-------)
    + [디플로이먼트](#------)
    + [HTTP로드밸런싱, 인그레스](#http-----------)
    + [StatfulSet](#statfulset)
  * [배치 워크로드](#-------)

---

## 기본 오브젝트

### Pod(파드)

'고래떼' 라는 뜻으로 쿠버네티스 상에서 더이상 쪼갤 수 없는 컨테이너 모음.

통신 네임 스페이스를 공유한다.

쿠버네티스에서 최소 단위가 되는 오브젝트로써, 파드를 중심으로 레플리카 및 스케일 아웃을 실행하기 때문에 스케일 아웃이 일어나더라도 오버헤드가 많지 않는 정도의 크기를 잘 설정하여 파드로 묶어야 한다.

- EX) 
  - Spring으로 만든 RestAPI 서버와, 1차 DB역할을 하는 MongoDB (x)
  - Pod를 둘로 쪼개야 함 (o)
    1. Spring Rest API 만 갖고 있는 Pod
    1. MongoDB에서 클러스터링의 최소 조건을 갖고있는 Mongos인스턴스 컨테이너 1개와, 여러대의 Mongod 컨테이너 및 ConfigServer 컨테이너

### ReplicaSet(레플리카셋)

가용성(Availability) 즉 무중단을 위한 확장(Scale-out)이나 failOver를 위한 복제를 ReplicaSet으로 처리한다.

Stateless여야 한다.

~~ReplicationController~~는 구버전 용이다.

### Service(서비스)

여러 레플리카에 트래픽을 분산시키는 로드 밸런싱 서비스.

구성

- 자체 IP주소
- K8s클러스터 DNS항목
- 로드밸런싱 규칙

서비스의 고정IP주소가 주어지면, K8sDNS에 서비스명으로 등록된다.

### 스토리지

수도없이 확장되고 복제되고 파기되는 Pod들 사이에서 유지해야할 파일관리를 위한 오브젝트

볼륨 인터페이스로 CSI를 사용한다.

Docker-Compose의 volumne과 같음.

#### Persistent Volume(영속성 볼륨)

볼륨 제공자가 없이 자체 스토리지(NAS,SAN등) 사용시에 사용한다.

스토리지에서 K8s로의 연결 시 직접 Pod에 요청하는것이 아닌 PersistentVolumes에 요청하게되면 PersistentVolumesClaims가 PersistentVolumes 오브젝트를 직접 POD에 할당한다.

#### Config Map

컨테이너 이미지마다 다른 구성을 이용하는 Volume을 마운트 할 수 있다.

#### Secret

Config Map과 동일한 동작구조를 가지지만 인증서, 암호와 같은 보언데이터에 유형을 구분하여 각 컨테이너마다 다른 Volume을 마운트 할 수 있도록 지정 할 수 있다.

## 구성 오브젝트

### 네임스페이스

API오브젝트들을 위한 디렉터리. `C# namespace/java package`와 비슷함

폴더구조를 사용하며 Namespace를 지우면 내부의 모든 오브젝트가 같이 삭제됨.

`default`와 `kube-system`기본제공.

RBAC(접근제어)시 사용가능

### 레이블

오브젝트식별을 위한 문자열 Key-value

태그 또는 메타데이터라고 보면 된다. AWS에 있는것과 같은걸로 보이며, 이걸 통해서 RBAC 또는 ip연동 등등을 할 수 있다. 그걸 레이블 쿼리라 한다.

### 어노테이션

말 그대로 주석이다, 아이콘이나 수정자 같은 것들이 들어가 있을 수 있다.

## 고급 오브젝트

### 디플로이먼트

새버전으로의 안전한 배포를 위해 추가된 오브젝트이다.

여러개의 ReplicaSet에 대한 포인터를 들고 있으며 한쪽에서 다른쪽으로 빠르게 이동제어를 할 수 있다.

방식은 ReplicaSet개수에 맞춰서 새 버전으로 배포 시에, 1개씩 새 버전의 ReplicaSet으로 변경 하면서 배포하게 된다.

### HTTP로드밸런싱, 인그레스

서비스내부에서의 로드밸런싱은 TCP수준에서의 로드밸런싱이다. 대부분의 HTTP를 사용하는 서비스에서 HTTP Application수준의 로드밸런싱이 필요 할 때가 있는데 그때 인그레스를사용한다.

### StatfulSet

ReplicaSet의 보완 책으로 나온 방식으로 각 파드명은 AutoIncrement된 Id를 부여받으며 생성된다.

또한 각 파드의 생성 순서를 보장하며 스택방식으로 제일 Scaleout했다가 다시 파드를 제거하게 된다면 제일 나중에 생성된 파드가 제거된다.

### 배치 워크로드

#### Job

Job은 실행해야 할 작업 집합을 나타낸다. ReplicaSets, StatefulSets와 달리 작업을 완료하고 종료 될 때 까지만 실행된다.

CronJob으로 스케줄까지 할 수 있다.

### 클러스터 에이전트 및 유틸리티

K8s를 활용하여 실행시키지 않은 클러스터에는 쿠버네티스가 리소스 계산을 못하고, K8s API도 사용할 수 없다.

다행히 수동 실행된 해당 클러스터에 DaemonSet이라는 유틸리티를 설치하면 K8s에서 관리할 수 있게 된다.

--- 

## 구성

### 선언적 구성

쿠버네티스는 기본적으로 대화형이 아닌 Yaml Json등을 이용해서 상태를 선언하는 방식으로 작동시킨다.

### 조정 컨트롤러
 
K8s에서의 자가 복구, 수정은 분산 방식을 취해서 구성되어 있다. 여러 컨트롤러로 구성되어 있으며 각 컨트롤러는 자체 독립 조정 루프를 수행한다.

### 암시적 그룹화

K8s는 레이블, 레이블쿼리를 이용하여 내부에서 암시적/동적으로 그룹화를 진행한다.

### 유닉스 철학

조각 구성이라는 유닉스 철학을 따라서 작은 여러조각의 프로세스들로 동작한다.

### API기반 상호작용

모든 상호작용이 동일한 API로 이루어진다. 이는 특정 인스턴스가 특권을 갖고 하게 되는 일이 없다. 
- 엘라스틱 서치에서의 각 인스턴스를 Node라고 하고 모든 Node는 같은 인스턴스인 것과 비슷한 느낌인 것 같다.

### 헤드노드

쿠버네이트 API기능을 구현하는 요소들이 모여있는 집합.

#### etcd

etcd시스템에서, 모든 오브젝트가 유지되는 key-value스토어.

CAS 및 워치 프로토콜을 구현한 구현체로, 동시성을 보장하고 변경사항에 대한 감시를 진행한다.

#### API 서버

클러스터에 접근 할 수 있는 Gateway

#### 스케줄러

파드가 실행될 위치를 찾고 노드를 결정한다.

#### 컨트롤러 관리자

파드 내부에서 ReplicaSets, Deployment, Service가 작동 할 수있도록 관리하는 요소

### 전체 노드

헤드, 컨트롤, 플랜 구분 없이 모든 노드가 공통적으로 갖고있는 요소

#### 쿠블렛

노드 데몬으로써 컴퓨팅 리소스(CPU,Disk,Mem 등) 상태를 API서버로 보내고 API서버로부터 오는 관리에 대한 기능을 수행하면서 컨테이너가 실행될 적정한 노드를 고를수 있도록 돕는다.

#### Kube-proxy

도커에서의 docker-bridge와 같은 위치이다, 단 단순 네트워크 분리 및 격리의 목적이 아닌 로드밸런싱을 담당한다.

### 스케줄된 구성

쿠버네티스클러스터링을 유지하기위해 내부적으로 스케줄되어 동작해야되는 구성요소들이 있다.

#### 쿠버DNS

DNS서비스를 대체하여 자체 DNS서버를 구현하여 내부적으로 로드밸런싱 등등을 위해 활용 되고 있는 요소

#### ~~힙스터~~

컴퓨팅 리소스 메트릭을 수집하여, 모니터링 시스템으로 푸시하고 k8s에서 auto-scaling구현 시 파드와 컨테이너의 위치조정, 크기조정 등을 수행 할 수 있게 도와준다.

1.13에서 Deprecated

