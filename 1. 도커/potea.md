# 도커/쿠버네티스를 활용한 컨테이너 개발 실전 입문

## 01 도커의 기초
- 도커란 무엇인가
- 도커를 사용하는 의의
- 로컬 도커 환경 구축하기

### 1 도커란 무엇인가
- Docker
    - 컨테이너형 가상화 기술을 구현하기 위한 상주 애플리케이션
    - 상주 애플리케이션을 조작하기 위한 명령행 도구
    - 경량 컨테이너
    - 개발 환경 구축, 운영 환경 배포
    - 어플리케이션 플랫폼 기능

#### 도커의 기본 개념
- 컨테이너형 가상화 기술
    - vs. 호스트 운영체제형 가상화 기술
- 애플리케이션이 중심이 되는 도커
    - 토커는 컨테이너에 애플리케이션 실행환경이 함게 배포되는 방식
- Dockerfile
    - FROM, COPY, RUN, CMD
- [Moby Project](https://github.com/moby/moby)
- [LinuxKit](https://github.com/linuxkit/linuxkit)

### 2 도커를 사용하는 의의
> 이 책은 도커를 애플리케이션의 개발과 배포, 운영에 어떻게 사용하는지를 다룬다.
> "익숙한 방식을 버리면서까지 도커를 도입해야 할 이유가 뭘까?" (p. 11)

- 환경 차이로 인한 문제 방지
    - 코드로 관리하는 인프라(Infrastructure as Code)
        - 같은 결과가 보장되는 멱등성(Idempotency)을 확보
    - 불변 인프라(Immutable Infrastructure)
        - 어떤 시점의 서버 상태를 저장해 복제할 수 있게 하자
    - 애플리케이션과 인프라 묶어 구축하기
- 애플리케이션 구성 관리의 용의성
    - **도커 컨테이너는 애플리케이션과 인프라를 함께 담은 상자다.**
        - 일정 규모를 넘는 시스템은 여러개의 애플리케이션과 미들웨어를 조합하는 형태로 구성한다.
        - *Microservice와 Docker를 함께...*
    - 도커 컨테이너 오케스트레이션 시스템
        - Docker Compose : 여러 컨테이너를 사용하는 애플리케이션을 쉽게 관리
        - Container Orchestration : *여러 서버에 걸쳐 있는 여러 컨테이너 관리*하는 기법
            - Docker Swarm
            - Kubernetes

### 3 로컬 도커 환경 구축하기
- Windows/macOS : Docker Community Edition 설치
- Linux : CentOS, Debian, Fedora, Ubuntu 배포만마다 조금씩 다름
    - Ubuntu 파생 배포판의 경우 조금씩 다름 (APT repository 설정에 주의 필요)

---
## 02 도커 컨테이너 배포
- 컨테이너로 애플리케이션 실행하기
- 도커 이미지 다루기
- 도커 컨테이너 다루기
- 운영과 관리를 위한 명령
- 도커 컴포즈로 여러 컨테이너 실행하기
- 컴포즈로 여러 컨테이너 실행하기 (실습)

### 1 컨테이너로 애플리케이션 실행하기
- 도커 이미지
    - 도커 컨테이너를 구성하는 파일 시스템과 실행할 어플리케이션 설정을 하나로 합친 것
    - 컨테이너를 생성하는 템플릿 역할을 한다.
- 도커 컨테이너
    - 도커 이미지를 기반으로 생성
    - 파일 시스템과 애플리케이션이 구체화되어 실행되는 상태

#### Dockerfile
- FROM : 도커 이미지의 바탕이 될 베이스 이미지를 지정
    - 도커 허브(Docker Hub) 레지스트리에 공개된 것
- RUN : 도커 이미지를 실행할 때 컨테이너 안에서 실행할 명령을 정의
- COPY : 도커가 동작중인 호스트 머신의 파일이나 디렉터리를 도커 컨테이너 안으로 복사
- ADD : COPY와 비슷한데 9장에 나온다!
- CMD : 도커 컨테이너를 실행할 때 컨테이너 안에서 실행할 프로세스를 지정한다
    - RUN 인스트럭션은 이미지를 빌드할 때 실행
    - CMD 인스트럭션은 컨테이너를 시작할 때 한 번 실행

#### 도커 이미지 빌드하기
- docker image build

#### 도커 컨테이너 실행
- docker container run
- 포트 포워딩

### 2 도커 이미지 다루기
> 도커 사용법은 이미지를 대상으로 하는 것과 컨테이너를 대상으로 하는 것으로 나뉜다.

- docker image build : 이미지 빌드하기
- docker search : 도커 허브에 등록된 리포지토리 검색하기
- docker image pull : 도커 레지스트리에서 이미지 내려받기
- docker image ls : 보유한 도커 이미지 목록 보기
- docker image tag : 이미지에 태크 붙이기
- docker image push : 저장된 도커 이미지를 도커 허브 등의 레지스트리에 공개

### 3 도커 컨테이너 다루기
> 도커 컨테이너는 가상 환경이다.
> 파일 시스템과 애플리케이션이 함께 담겨 있는 박스

- 도커 컨테이너의 생애주기
    - 실행 중 상태
    - 정지 상태
    - 파기 상태
- docker container run : 컨테이너 생성 및 실행
- docker container ls : 컨테이너 목록 보기
- docker container stop : 컨테이너 정지하기
- docker container restart : 컨테이너 재시작하기
- docker container rm : 컨테이너 파기하기
- docker container logs : 컨테이너의 표준 출력 내용을 확인하기(표준 출력 연결하기)
- docker container exec : 실행 중인 컨테이너에서 명령 실행하기
- docker container cp : 컨테이너끼리 혹은 컨테이너와 호스트 간에 파일 복사하기

### 4 운영과 관리를 위한 명령
- 컨테이너 및 이미지 파기
    - docker container prune : 실행중이 아닌 모든 컨테이너 삭제
    - docker image prune : 태그가 붙지 않은 모든 컨테이너 삭제
    - docker system prune : 도커 이미지, 컨테이너, 볼륨, 네트워크 등 모든 도커 리소스를 일괄적으로 삭제
- 사용 현황 확인하기
    - docker container stats : UNIX 계열의 top 명령과 같은 역할

### 5 도커 컴포즈로 여러 컨테이너 실행하기
- Compose는 yaml 포멧으로 기술된 설정 파일로 여러 컨테이너의 실행을 한 번에 관리할 수 있게 해준다.
- docker-compose.yml 파일을 작성하면 기존 docker 명령을 사용해 컨테이너를 실행할 때 매번 부여하던 옵션을 설정 파일로 관리할 수 있다.

---
## 03 컨테이너 실전 구축 및 배포
- 애플리케이션과 시스템 내 단일 컨테이너의 적정 비중
- 컨테이너의 이식성
- 도커 친화적인 애플리케이션
- 퍼시스턴스 데이터를 다루는 방법
- 컨테이너 배치 전략

### 1 애플리케이션과 시스템 내 단일 컨테이너의 적정 비중
> 컨테이너는 하나의 관심사에만 집중해야 한다. (p. 94)
- 컨테이너 1개 == 프로세스 1개를 억지로 고수하는 것보다 1개 이상의 프로세스를 실행하는 컨테이너를 허용하는 쪽이 간결한 형태를 유지할 수 잇는 경우가 많다.


### 2 컨테이너의 이식성
- 도커의 큰 장점은 이식성(portability)에 있다.
- 도커의 이식성은 완벽하지 않아서 몇 가지 예외가 존재한다.
    - 커널 및 아키텍처의 차이
    - 라이브러리와 동적 링크 문제

### 3 도커 친화적인 애플리케이션
- 어플리케이션 동작을 환경 변수로 제어 (권장)
- 설정 파일에 환경 변수를 포함

### 4 퍼시스턴스 데이터를 다루는 방법
- 새로운 버전의 컨테이너가 배포되더라도 이전 버전의 컨테이너에서 사용하던 파일 및 디렉터리를 사용할 수 있어야한다.
- 데이터 볼륨(data volume)
    - 도커 컨테이너 안의 디렉터리를 디스크에 퍼시스턴스 데이터로 남기기 위한 메커니즘
    - 호스트와 컨테이너 사이의 디렉터리 공유 및 재사용 기능을 제공

### 5 컨테이너 배치 전략
- 도커 스웜(Docker Swarm)
    - 여러 도커 호스트를 클러스터로 묶어주는 컨테이너 오케스트레이션 도구의 한 종류

|이름|역할|명령어|
| - | - | - |
|컴포즈|여러 컨테이너로 구성된 도커 어플리케이션을 관리(주로 단일 호스트)|docker-compose|
|스웜|클러스터 구축 및 관리(주로 멀티 호스트)|docker swarm|
|서비스|스웜에서 클러스터 안의 서비스(컨테이너 하나 이상의 집합)를 관리|docker service|
|스택|스웜에서 여러 개의 서비스를 합한 전체 어플리케이션을 관리|docker stack| 

- Docker Machines : 물리 호스트 1대에 여러 대의 도커 호스트 사용
    - macOS는 virtualbox 드라이버, Windows는 hyperv 드라이버 필요
- Docker in Docker, dind : 도커 컨테이너 안에서 도커 호스트를 실행
    - dind를 사용해 도커 스웜 클러스터 구축

---
## 04 스웜을 이용한 실전 애플리케이션 개발
- 웹 애플리케이션 구성
- MySQL 서비스 구축
- API 서비스 구축
- Nginx 구축
- 웹 서비스 구축
- 컨테이너 오케스트레이션을 적용한 개발 스타일
