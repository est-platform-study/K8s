# 클러스터 구축

## 노드

1. 헤더
2. 일반

### 노드 구성 요소들

1. 헤더
    - etcd
2. 공통
    - 쿠블렛

### k8s 프로세스

k8s 에서 노드들을 이용하여 적절한 서비스를 제공하기 위해 구분된 프로세스들 (서비스들)

#### API 서비스

- k8s의 모든 서비스요청은 여기다가 한다.
- http rest 이다.
- 파드 구성, 설정, 로깅 등등을 요청 할 수 있다.

#### 스케줄링 서비스

nodeName이 없는 pod들(default) 을 구성 할 때 어떤 노드에 배치 시키고 클러스터링 하는지 설정하고 배치 시키는 서비스

- Default
  - 우선순위 큐를 이용한 RR 방식 알고리즘을 채용한다.

- pod 충돌
  - 오케스트레이션 되지 않는 단일 pod로 된 서비스 실행 요청도, 아예 다른 pod로 인한 node의 자원 할당과 맞물려 실패가 날 수 있기 때문데 반드시 Replicaset을 채용하거나, deployment를 이용하여 스케줄링을 탈 수 있도록 실행 해야 한다.

##### 노드 강제 선택

- 노드 셀렉터
  - 고성능, 저성능 노드들의 자원 상태를 고려해 할당 가능하다.
- 노드 어피니티, 파드 어피니티
  - 노드 셀렉터와 비슷한 개념으로 제약 조건으로 노드를 선택하게끔 하는 기능
- 노드 테인트
  - 구형으로 오래된 아무도 쓰고싶지 않은 node들을 테인트로 지정하여 테스트나 특별히 시스템 리소스를 잡아먹지 않는 pod들을 톨러레이션으로 사용 할 수 있게끔 해주는 기능

## 구축

### 쿠베어드민

1. 리눅스 위에서만 설치
2. 쿠블렛 설치
3. docker, rkt, CRI-O 인데 우리는 docker 로합시다.
    - 이것들을 컨테이너 런타임이라 부름
4. docker, 쿠블렛이 깔린 상태에서 어드민 설치
    - ```kubeadm init``

#### preflight-checks

설치 이후 여러가지 사전 점검 실시함.

#### CA

preflight-checks 이후 자체적으로 CA 생성을 한다. 특정 사내 인증서 제공을 이용해서 만들기 위해서는 /etc/kubernates/pki에 인증서를 미리 제공해두면 된다.

#### etcd

etcd 서버 인스턴스로 클러스터 정보들을 저장 할 것이다.
이는 중요한 데이터 스토어 인스턴스로서 웬만하면 컨트롤 노드에서 분리해서 따로 만들어 두는게 좋다.

#### 쿠베 컨피그

pki관련 파일, 인증 수단에 사용되는 구성으로 /etc/kubernates/admin.conf 에 저장함.
k8s 사용자 (일반적으로 이들도 개발자) 들이 사용하면 안되고, 클러스터 관리자 (SE 나 Devops 겠지) 들이 클러스터 부트 스트랩 용도로만 사용하는걸 적극 권장함

#### 테인트

오염된, 오래된, 다들 잘 쓰기 싫어하는 서버리소스를 갖고있는 노드 태깅을 설정으로 할 수 있다.

#### 워커 노드

API, 헤더 노드 가 아닌 노드들에 설치 할 때 사용 방법

1. 똑같이 ```kubeadm init``` 수행
2. ```kubeadm join --token <token> --discovery-token-ca-cert-hash <hash> \ <api endpoint>```

#### 애드온

- CNI 플러그인은 무조건 따로 설치 해야 함.

#### phase

- 쿠베 어드민은 다른 다양한 k8s 설치 툴의 베이스가 될 수 있도록 phase라는 기능을 제공함.
